---
title: "3_MR_Summary_Plotter"
author: "Jonathan Chan"
date: "2025-02-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggrepel)

theme_set(theme_classic())
```

This Rmd notebook details the summary plotting of the results from bidirectional , 2-sample MR of HCM-related traits with HCM case/control status.

The 32 GWS SNPs from Tadros et al, 2025 are used as the instruments for the HCM -> phenotype X direction.

## Import

```{r import}

results_folder <- '../3_output/2_MR/'

analyses <- list.dirs(results_folder, recursive=F, full.names=F)
analyses <- analyses[!analyses %in% c('archive_preIVWchange', 'archive_CVDHugeAmpInstruments', 'subgroup_analyses') & !str_detect(analyses, 'DCM')]
#Don't include DCM analyses in overall plot

mainline_results_importer <- function(folder){
  mainline_results <- read.table(str_c(folder, '/',str_match(folder,'\\/([^\\/]+)_to_')[,2], '_mr_results_mainline.tsv')) %>%
    select(-id.exposure, -id.outcome) %>%
  mutate(exposure = ifelse(exposure=='bmi', 'BMI', exposure),
         outcome = ifelse(outcome=='bmi', 'BMI', outcome)) %>%
    mutate(exposure_outcome = str_c(exposure, outcome, sep=' -> '))
  
  return(mainline_results)
}

mr_results <- map(str_c(results_folder, analyses), ~mainline_results_importer(.)) %>% bind_rows()

write_tsv(mr_results, str_c(results_folder, 'summary_MR_results.tsv'))
```
Define the grouping of the phenotypes into different parameter groups here.

```{r}
crf_vars <- c('BMI', 'CRP','DrinksPerWeek','SmokingInitiation','T2D', 'DBP','eGFR')
ecg_vars <- c('PRinterval','PwaveDuration','QRSinterval','QTcInterval','RRinterval','QTinterval')
fibrosis_vars <- c('T1time')
LV_diastolic_vars <- c('longdsr','radialdsr', 'maxLAVi')
RV_vars <- c('minRAAi','maxRAAi', 'RA_Frac_Change','RVEDVI','RVEF','RVESVI','RVSVI')
related_disease_vars <- c('AF', 'HF')
```

```{r}
sensitivity_or_results_importer <- function(folder){
  mainline_results <- read.table(str_c(folder, '/',str_match(folder,'\\/([^\\/]+)_to_')[,2], '_mr_results_sensitivity_oddsratio.tsv')) %>%
    select(-id.exposure, -id.outcome) %>%
  mutate(exposure = ifelse(exposure=='bmi', 'BMI', exposure),
         outcome = ifelse(outcome=='bmi', 'BMI', outcome)) %>%
    mutate(exposure_outcome = str_c(exposure, outcome, sep=' -> '))
  
  return(mainline_results)
}

mr_results_or <- map(str_c(results_folder, analyses), ~sensitivity_or_results_importer(.)) %>% bind_rows() %>%
  filter(method=='Inverse variance weighted') %>%
  mutate(mtc_pval = p.adjust(pval, method='holm')) %>%
  mutate(label = ifelse(mtc_pval <= 0.05, exposure_outcome, '')) %>%
  mutate(group = ifelse(exposure=='HCM', 'HCM -> X', 'X -> HCM')) %>% #Separate a group variable based on whether HCM is the exposure or outcome
    mutate(exposure_phenogroup = case_when( exposure %in% crf_vars ~ 'CRF',
                                        exposure %in% related_disease_vars ~'Related Diseases',
                                        exposure %in% ecg_vars ~ 'ECG',
                                        exposure %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        exposure %in% LV_diastolic_vars ~ 'LV Diastolic Function',
                                        exposure %in% RV_vars ~ 'RV Function')) %>%
  mutate(outcome_phenogroup = case_when( outcome %in% crf_vars ~ 'CRF',
                                        outcome %in% related_disease_vars ~'Related Diseases',
                                        outcome %in% ecg_vars ~ 'ECG',
                                        outcome %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        outcome %in% LV_diastolic_vars ~ 'LV Diastolic Function',
                                        outcome %in% RV_vars ~ 'RV Function')) %>%
  mutate(nonHCM_phenogroup = case_when(is.na(exposure_phenogroup) ~ outcome_phenogroup, #This creates the phenogroup for the non-HCM variable in the analysis
                                       is.na(outcome_phenogroup) ~ exposure_phenogroup, 
                                       T~NA)) %>%
  mutate(nonHCM_phenogroup=factor(nonHCM_phenogroup, levels=unique(nonHCM_phenogroup)))

write_tsv(mr_results_or, str_c(results_folder, 'summary_MR_results_oddsratio.tsv'))
```

This provides normalisation of BMI and DBP traits to convert their per-unit effect to per-SD effect using the original SD from their publications supplementary information.

```{r}
bmi_dbp_normalisation=T

bmi_dbp_normaliser <- function(input_tb, type='mr_results'){
   # Define standard deviations and sample sizes for three studies
  sds <- c(11, 12, 11)        # Standard deviations for the three samples
  ns <- c(220501, 50649, 458577)      # Corresponding sample sizes
  
  # Calculate the pooled standard deviation using base R
  dbp_keaton24_sd <- sqrt(
    sum((ns - 1) * sds^2) / sum(ns - 1)
    )
  
  #Repeat with BMI
  sds <- c(4.32,5.58,3.76,4.72,3.4,4.43,4.19,4.97,4.43,5.37,3.65,4.76)
  ns <- c(4652,6954,4385,5891,10190,15522,16833,23150,15738,27262,18525,19285)
  bmi_sidorenko24_sd <- sqrt(
    sum((ns - 1) * sds^2) / sum(ns - 1)
    )
  
  rm(sds,ns)
  
  #Transform the mr_results and mr_results_or tibbles
  if(type=='mr_results'){
      output_tb <- input_tb %>%
    mutate(b = case_when(exposure_outcome== 'BMI -> HCM'~ b * bmi_sidorenko24_sd,
                         exposure_outcome == 'DBP -> HCM' ~ b * dbp_keaton24_sd,
                         T~b))
  } else if (type=='mr_results_or'){
      output_tb <- input_tb %>%
    mutate(b = case_when(exposure_outcome== 'BMI -> HCM'~ b * bmi_sidorenko24_sd,
                         exposure_outcome == 'DBP -> HCM' ~ b * dbp_keaton24_sd,
                         T~b),
           lo_ci= case_when(exposure_outcome== 'BMI -> HCM'~ lo_ci * bmi_sidorenko24_sd,
                         exposure_outcome == 'DBP -> HCM' ~ lo_ci * dbp_keaton24_sd,
                         T~lo_ci),
           up_ci = case_when(exposure_outcome== 'BMI -> HCM'~ up_ci * bmi_sidorenko24_sd,
                         exposure_outcome == 'DBP -> HCM' ~ up_ci * dbp_keaton24_sd,
                         T~up_ci) )
  } else{
    print('Not supported tibble type')
    stop()
  }
  
  return(output_tb)

  
}

if(isTRUE(bmi_dbp_normalisation)){
  mr_results <- bmi_dbp_normaliser(mr_results)
  mr_results_or <- bmi_dbp_normaliser(mr_results_or, type='mr_results_or')
}
```


## Summary Plotting

This plots a volcano plot of all the MR analyses with Holm's p-value correction for multiple testing correction (controls FWER but with greater power than Bonferroni and also does not assume independence between tests).

```{r}
#Apply multiple testing correction to the tests
mr_results <- mr_results %>%
  mutate(mtc_pval = p.adjust(pval, method='holm')) %>%
  mutate(group = ifelse(exposure=='HCM', 'HCM -> X', 'X -> HCM')) %>% #Separate a group variable based on whether HCM is the exposure or outcome
  mutate(label = ifelse(mtc_pval <= 0.05, exposure_outcome, '')) %>%
  mutate(exposure_phenogroup = case_when( exposure %in% crf_vars ~ 'CRF',
                                        exposure %in% related_disease_vars ~'Related Diseases',
                                        exposure %in% ecg_vars ~ 'ECG',
                                        exposure %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        exposure %in% LV_diastolic_vars ~ 'LV Diastolic Function',
                                        exposure %in% RV_vars ~ 'RV Function')) %>%
  mutate(outcome_phenogroup = case_when( outcome %in% crf_vars ~ 'CRF',
                                        outcome %in% related_disease_vars ~'Related Diseases',
                                        outcome %in% ecg_vars ~ 'ECG',
                                        outcome %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        outcome %in% LV_diastolic_vars ~ 'LV Diastolic Function',
                                        outcome %in% RV_vars ~ 'RV Function')) %>%
  mutate(nonHCM_phenogroup = case_when(is.na(exposure_phenogroup) ~ outcome_phenogroup, #This creates the phenogroup for the non-HCM variable in the analysis
                                       is.na(outcome_phenogroup) ~ exposure_phenogroup, 
                                       T~NA)) %>%
  mutate(nonHCM_phenogroup=factor(nonHCM_phenogroup, levels=unique(nonHCM_phenogroup)))
```


```{r}
#Output the summary scatter plot of pvalue with effect size
summary_scatter <- ggplot(mr_results,aes(x=b,y=-log10(mtc_pval)))+
  geom_point(aes(shape=group, col=nonHCM_phenogroup))+
  geom_vline(xintercept=0, linetype='dashed', col='black')+
  geom_hline(yintercept=-log10(0.05), linetype='dashed', col='black')+
  geom_text_repel(aes(label=label, col=nonHCM_phenogroup))+
  xlab('Beta (Increase in Outcome per SD, Unit or Log-Odds Increase in Exposure)')+
  ylab('-log10 (Adjusted p-value)')+
  labs(shape='Direction', col='Non-HCM Phenotype Group')+
  labs(title=str_wrap(str_c('Summary plot of 2-sample Mendelian Randomisation for ', nrow(mr_results), ' analyses'))
       #,caption='Labelled if significant after MTC'
       )

print(summary_scatter)
ggsave('../3_output/3_summary_plots/MR_summary_plot.png',summary_scatter, dpi=600, width=9, height=6)

#Note that the RV traits all provide GWAS summary statistics/betas from the inverse-rank-normalised phenotypes. So their phenotype will be measured in SD.
#Likewise with DBP and BMI which are normalised using the SD from the original publication.
```

Also include the plot with 95% confidence interval.
```{r}
#Output the summary scatter plot of pvalue with effect size
summary_scatter_confint <- ggplot(mr_results_or,aes(x=b,y=-log10(mtc_pval)))+
  geom_point(aes(shape=group, col=nonHCM_phenogroup))+
  geom_errorbar(aes(xmin=lo_ci, xmax=up_ci, col=nonHCM_phenogroup))+
  geom_vline(xintercept=0, linetype='dashed', col='black')+
  geom_hline(yintercept=-log10(0.05), linetype='dashed', col='black')+
  geom_text_repel(aes(label=label, col=nonHCM_phenogroup))+
  xlab('Beta (Increase in Outcome per SD, Unit or Log-Odds Increase in Exposure)')+
  ylab('-log10 (Adjusted p-value)')+
  labs(shape='Direction', col='Non-HCM Phenotype Group')+
  labs(title=str_wrap(str_c('Summary plot of 2-sample Mendelian Randomisation for ', nrow(mr_results), ' analyses'))
       ,caption='Errorbars = 95% confidence interval'
       )

print(summary_scatter_confint)
ggsave('../3_output/3_summary_plots/MR_summary_plot_confint.png',summary_scatter_confint, dpi=600, width=9, height=6)

#Note that the RV traits all provide GWAS summary statistics/betas from the inverse-rank-normalised phenotypes. So their phenotype will be measured in SD.
```

## Forest Plot for Significant Conclusions

```{r}
sig_mr_results_or <- mr_results_or %>%
  filter(exposure_outcome %in% filter(mr_results,mtc_pval <=0.05)$exposure_outcome)

thanaj_dsr_normalisation <- T

thanaj_dsr_normaliser <- function(input_tb){
  longdsr_thanaj22_sd <- 0.6
  radialdsr_thanaj22_sd <- 1.9
  
  output_tb <- input_tb %>%
    mutate(b = case_when(outcome=='longdsr' ~ b/longdsr_thanaj22_sd,
                         outcome == 'radialdsr' ~ b/radialdsr_thanaj22_sd,
                         T ~ b),
           lo_ci = case_when(outcome=='longdsr' ~ lo_ci/longdsr_thanaj22_sd,
                         outcome == 'radialdsr' ~ lo_ci/radialdsr_thanaj22_sd,
                         T ~ lo_ci),
           up_ci = case_when(outcome=='longdsr' ~ up_ci/longdsr_thanaj22_sd,
                         outcome == 'radialdsr' ~ up_ci/radialdsr_thanaj22_sd,
                         T ~ up_ci))
}

if(isTRUE(thanaj_dsr_normalisation)){
  sig_mr_results_or <- thanaj_dsr_normaliser(sig_mr_results_or)
}

#Create a faceted plot where I have the top plot = per-unit OR and the bottom plot = per-SD OR

if(isTRUE(bmi_dbp_normalisation)){
  sig_mr_results_or <- sig_mr_results_or %>%
    mutate(exposure_plot_group = case_when(exposure%in% c(RV_vars, 'BMI','DBP') ~ 'Per-SD Exposure', 
                                         exposure == 'HCM' ~ 'Per-Log(Odds) Exposure',
                                         T~'Per-Unit Exposure'))
}else{
  sig_mr_results_or <- sig_mr_results_or %>%
    mutate(exposure_plot_group = case_when(exposure%in% c(RV_vars) ~ 'Per-SD Exposure', 
                                         exposure == 'HCM' ~ 'Per-Log(Odds) Exposure',
                                         T~'Per-Unit Exposure'))
}

sig_mr_results_or <- sig_mr_results_or %>%
  mutate(outcome_plot_group = ifelse(outcome %in% c('HCM',related_disease_vars,'T2D','SmokingInitiation'), 'OR', 'beta')) %>%
  mutate(exposure_outcome=factor(exposure_outcome))

forest_plot1 <- ggplot(sig_mr_results_or)+
  geom_point(aes(x=b, y= exposure_outcome, col=nonHCM_phenogroup))+
  geom_errorbar(aes(xmin=lo_ci, xmax=up_ci, y=exposure_outcome,col=nonHCM_phenogroup))+
  geom_vline(xintercept=0, col='black', linetype='dashed')+
  xlab(ifelse(isTRUE(bmi_dbp_normalisation), 'Change in Log-Odds(Discrete Outcome) or in SD (Continuous Outcome) \n per Log-Odds or SD Exposure','Change in Log-Odds(Discrete Outcome) or in SD (Continuous Outcome) \n per Log-Odds, SD, or Unit Exposure'))+
  ylab('Exposure -> Outcome')+
  labs(col='Non-HCM Phenotype Group')+
  facet_wrap(vars(exposure_plot_group), nrow=3, drop=TRUE, scales='free')

print(forest_plot1)
ggsave('../3_output/3_summary_plots/sig_MR_forestplot.png',forest_plot1, dpi=600, width=9, height=6)
```

## Subgroup Analyses

```{r}
results_folder <- '../3_output/2_MR/subgroup_analyses/'
analyses <- list.dirs(results_folder, recursive=F, full.names=F)

subgroup_mr_results_or <- map(str_c(results_folder, analyses), ~sensitivity_or_results_importer(.)) %>% bind_rows() %>%
  filter(method=='Inverse variance weighted') %>%
  mutate(label = ifelse(pval <= 0.05, exposure_outcome, '')) %>%
  mutate(group = ifelse(str_detect(exposure, 'HCM'), 'HCM -> X', 'X -> HCM')) %>% #Separate a group variable based on whether HCM is the exposure or outcome
    mutate(exposure_phenogroup = case_when( exposure %in% crf_vars ~ 'CRF',
                                        exposure %in% related_disease_vars ~'Related Diseases',
                                        exposure %in% ecg_vars ~ 'ECG',
                                        exposure %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        exposure %in% LV_diastolic_vars ~ 'LV Diastolic Function',
                                        exposure %in% RV_vars ~ 'RV Function')) %>%
  mutate(outcome_phenogroup = case_when( outcome %in% crf_vars ~ 'CRF',
                                        outcome %in% related_disease_vars ~'Related Diseases',
                                        outcome %in% ecg_vars ~ 'ECG',
                                        outcome %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        outcome %in% LV_diastolic_vars ~ 'LV Diastolic Function',
                                        outcome %in% RV_vars ~ 'RV Function')) %>%
  mutate(nonHCM_phenogroup = case_when(is.na(exposure_phenogroup) ~ outcome_phenogroup, #This creates the phenogroup for the non-HCM variable in the analysis
                                       is.na(outcome_phenogroup) ~ exposure_phenogroup, 
                                       T~NA)) %>%
  mutate(nonHCM_phenogroup=factor(nonHCM_phenogroup, levels=unique(nonHCM_phenogroup)))
```


```{r}
sig_subgroup_mr_results_or <- subgroup_mr_results_or %>%
  filter(label!='')

thanaj_dsr_normalisation <- T

if(isTRUE(thanaj_dsr_normalisation)){
  sig_subgroup_mr_results_or <- thanaj_dsr_normaliser(sig_subgroup_mr_results_or)
}

#Create a faceted plot where I have the top plot = per-unit OR and the bottom plot = per-SD OR

if(isTRUE(bmi_dbp_normalisation)){
  sig_subgroup_mr_results_or <- sig_subgroup_mr_results_or %>%
    mutate(exposure_plot_group = case_when(exposure%in% c(RV_vars, 'BMI','DBP') ~ 'Per-SD Exposure', 
                                         str_detect(exposure, 'HCM') ~ 'Per-Log(Odds) Exposure',
                                         T~'Per-Unit Exposure'))
}else{
  sig_subgroup_mr_results_or <- sig_subgroup_mr_results_or %>%
    mutate(exposure_plot_group = case_when(exposure%in% c(RV_vars) ~ 'Per-SD Exposure', 
                                         str_detect(exposure, 'HCM')  ~ 'Per-Log(Odds) Exposure',
                                         T~'Per-Unit Exposure'))
}

sig_subgroup_mr_results_or <- sig_subgroup_mr_results_or %>%
  mutate(outcome_plot_group = ifelse(outcome %in% c('HCM','HCMsarcneg','HCMsarcpos',related_disease_vars,'T2D','SmokingInitiation'), 'OR', 'beta')) %>%
  mutate(exposure_outcome=factor(exposure_outcome))

forest_plot_subgroup<- ggplot(sig_subgroup_mr_results_or)+
  geom_point(aes(x=b, y= forcats::fct_reorder(exposure_outcome, outcome), col=nonHCM_phenogroup))+
  geom_errorbar(aes(xmin=lo_ci, xmax=up_ci, y=exposure_outcome,col=nonHCM_phenogroup))+
  geom_vline(xintercept=0, col='black', linetype='dashed')+
  xlab(ifelse(isTRUE(bmi_dbp_normalisation), 'Change in Log-Odds(Discrete Outcome) or in SD (Continuous Outcome) \n per Log-Odds(HCM) Exposure','Change in Log-Odds(Discrete Outcome) or in SD (Continuous Outcome) \n per Log-Odds Exposure'))+
  ylab('Exposure -> Outcome')+
  labs(col='Non-HCM Phenotype Group',  caption='95% confidence intervals shown')+
  facet_wrap(vars(exposure_plot_group), nrow=3, drop=TRUE, scales='free')

print(forest_plot_subgroup)
ggsave('../3_output/3_summary_plots/sig_MR_forestplot_subgroup.png',forest_plot_subgroup, dpi=600, width=9, height=6)
```


## Misc.

### Double-Check Separate Instruments

```{r}
library(readxl)

double_check_separate_instruments <- function(associations_filepath, reference_IVlist){
  
  phenotype_name <- str_match(associations_filepath, '\\/([A-Za-z_0-9]+)_associations\\.')[,2]
  
  if(any(str_detect(associations_filepath, 'tsv'))){ #i.e if a file path is passed instead of a list of SNPs
  associations_filepath <- read_tsv(associations_filepath, show_col_types=F) %>%
    filter(`P-VALUE` <= 5 * 10^-8) #Filter for only GWS SNPs in the passed in file
  associations_filepath <- associations_filepath$SNPS
} else if (any(str_detect(associations_filepath, 'csv'))){
  associations_filepath <- read_csv(associations_filepath, show_col_types=F) %>% 
    filter(pValue <= 5 * 10^-8) #Filter for only GWS SNPs in the passed in file
  associations_filepath <- associations_filepath$dbSNP
} else if (any(str_detect(associations_filepath, '.xlsx'))){
  associations_filepath <- read_excel(associations_filepath, sheet='Sheet1')
  associations_filepath <- associations_filepath$rsid
}
  
  overlap <- sum(associations_filepath %in% reference_IVlist)
  if(overlap == 0){
    print(str_c(phenotype_name, ' has no overlap with IV list'))
  } else {
    print(str_c(phenotype_name, ' HAS overlap with IV list'))
    overlapping_snps <- associations_filepath[which(associations_filepath %in% reference_IVlist)]
    print(str_c('Overlapping SNPs = ', str_c(overlapping_snps, collapse = ', ')))
  }
  
}

hcm_gws_snps = str_split_1("rs1048302,rs11687178,rs3845778,rs2540277,rs6747402,rs7612736,rs4894803,rs2191446,rs11748963,rs3176326,rs12210733,rs66520020,rs7824244,rs35006907,rs2645210,rs2177843,rs11196085,rs17617337,rs12270374,rs182427065,rs7487962,rs41306688,rs113907726,rs8006225,rs8033459,rs28768976,rs7210446,rs2644262,rs6566955,rs12460541,rs62222424,rs5760054",',')

association_files <- list.files('../1_data/gwas_associations/', pattern='associations', full.names=T)
walk(association_files, ~double_check_separate_instruments(.,hcm_gws_snps))

```


