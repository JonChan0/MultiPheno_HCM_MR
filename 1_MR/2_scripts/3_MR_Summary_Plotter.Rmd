---
title: "3_MR_Summary_Plotter"
author: "Jonathan Chan"
date: "2025-02-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggrepel)
library(patchwork)
rm(list=ls())

theme_set(theme_classic())
```

This Rmd notebook details the summary plotting of the results from bidirectional , 2-sample MR of HCM-related traits with HCM case/control status.

The 32 GWS SNPs from Tadros et al, 2025 are used as the instruments for the HCM -> phenotype X direction.

## Import

```{r import}

results_folder <- '1_MR/3_output/2_MR/'

analyses <- list.dirs(results_folder, recursive=F, full.names=F)
analyses <- analyses[!str_detect(analyses, 'archive|subgroup|DCM|sensitivity')]
#Don't include DCM analyses in overall plot

mainline_results_importer <- function(folder){
  mainline_results <- read.table(str_c(folder, '/',str_match(folder,'\\/([^\\/]+)_to_')[,2], '_mr_results_mainline.tsv')) %>%
    select(-id.exposure, -id.outcome) %>%
  mutate(exposure = ifelse(exposure=='bmi', 'BMI', exposure),
         outcome = ifelse(outcome=='bmi', 'BMI', outcome)) %>%
    mutate(exposure_outcome = str_c(exposure, outcome, sep=' -> '))
  
  return(mainline_results)
}

mr_results <- map(str_c(results_folder, analyses), ~mainline_results_importer(.)) %>% bind_rows()

write_tsv(mr_results, str_c(results_folder, 'summary_MR_results.tsv'))
```

Define the grouping of the phenotypes into different parameter groups here.

```{r}
crf_vars <- c('BMI','SmokingInitiation','T2D', 'DBP', 'AF','HF','CAD','stroke','eGFR')
fibrosis_vars <- c('T1time', 'hcmr2_ecvfwhole','hcmr2_lge_total')
LV_diastolic_vars <- c('longdsr','radialdsr', 'maxLAVi')
pp_vars <- c('hcmr_NTproBNP','hcmr_gal3','hcmr_TnT','hcmr_IL1RL1','hcmr_cicp','hcmr_mmp1',
             'ukb_NTproBNP','ukb_BNP','ukb_gal3','ukb_TnI','ukb_IL1RL1','ukb_mmp1')
```

```{r}
sensitivity_or_results_importer <- function(folder){
  mainline_results <- read.table(str_c(folder, '/',str_match(folder,'\\/([^\\/]+)_to_')[,2], '_mr_results_sensitivity_oddsratio.tsv'), header=T)
  
  if(nrow(mainline_results) == 0){
    return(tibble())
  } else{
      mainline_results <- mainline_results %>%
    select(-id.exposure, -id.outcome) %>%
  mutate(exposure = ifelse(exposure=='bmi', 'BMI', exposure),
         outcome = ifelse(outcome=='bmi', 'BMI', outcome)) %>%
    mutate(exposure_outcome = str_c(exposure, outcome, sep=' -> '))
  
  return(mainline_results)
    
  }
}

mr_results_or <- map(str_c(results_folder, analyses), ~sensitivity_or_results_importer(.)) %>%
  bind_rows() %>%
  filter(method %in% c('Wald ratio','Inverse variance weighted')) %>%
  mutate(mtc_pval = p.adjust(pval, method='BH')) %>%
  mutate(label = ifelse(mtc_pval <= 0.05, exposure_outcome, '')) %>%
  mutate(group = ifelse(exposure=='HCM', 'HCM -> X', 'X -> HCM')) %>% #Separate a group variable based on whether HCM is the exposure or outcome
    mutate(exposure_phenogroup = case_when( exposure %in% crf_vars ~ 'CRF',
                                        exposure %in% pp_vars ~ 'PP',
                                        exposure %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        exposure %in% LV_diastolic_vars ~ 'LV Diastolic Function')) %>%
  mutate(outcome_phenogroup = case_when( outcome %in% crf_vars ~ 'CRF',
                                        outcome %in% pp_vars ~ 'PP',
                                        outcome %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        outcome %in% LV_diastolic_vars ~ 'LV Diastolic Function')) %>%
  mutate(nonHCM_phenogroup = case_when(is.na(exposure_phenogroup) ~ outcome_phenogroup, #This creates the phenogroup for the non-HCM variable in the analysis
                                       is.na(outcome_phenogroup) ~ exposure_phenogroup, 
                                       T~NA)) %>%
  mutate(nonHCM_phenogroup=factor(nonHCM_phenogroup, levels=unique(nonHCM_phenogroup)))

write_tsv(mr_results_or, str_c(results_folder, 'summary_MR_results_oddsratio.tsv'))
```

```{r}

perunit_to_perSD_normaliser <- function(input_tb,pooled_sds, type='mr_results'){
    # `pooled_sds` should be a named vector or list where names match `exposure_outcome` values
  # Example: c("BMI -> HCM" = 4.3, "DBP -> HCM" = 11.5)

  if (!type %in% c('mr_results', 'mr_results_or')) {
    stop('Unsupported tibble type')
  }

  # Make sure all the names in pooled_sds are present in the data
  matched_traits <- names(pooled_sds)
  
  # Create a function to fetch the sd based on the exposure_outcome value
  get_sd <- function(trait) {
    if (trait %in% matched_traits) {
      return(pooled_sds[[trait]])
    } else {
      return(1)  # No change if trait is not listed
    }
  }

  # Apply transformation
  if (type == 'mr_results') {
    output_tb <- input_tb %>%
      rowwise() %>%
      mutate(b = b * get_sd(exposure_outcome)) %>%
      ungroup()
  } else if (type == 'mr_results_or') {
    output_tb <- input_tb %>%
      rowwise() %>%
      mutate(b = b * get_sd(exposure_outcome),
             lo_ci = lo_ci * get_sd(exposure_outcome),
             up_ci = up_ci * get_sd(exposure_outcome)) %>%
      ungroup()
  }

  return(output_tb)
}
```

This provides normalisation of BMI and DBP traits to convert their per-unit effect to per-SD effect using the original SD from their publications supplementary information.

```{r}
bmi_dbp_normalisation=T

# Define standard deviations and sample sizes for three studies
sds <- c(11, 12, 11)        # Standard deviations for the three samples
ns <- c(220501, 50649, 458577)      # Corresponding sample sizes

# Calculate the pooled standard deviation using base R
dbp_keaton24_sd <- sqrt(
  sum((ns - 1) * sds^2) / sum(ns - 1)
  )

rm(sds,ns)

#Repeat with BMI
sds <- c(4.32,5.58,3.76,4.72,3.4,4.43,4.19,4.97,4.43,5.37,3.65,4.76)
ns <- c(4652,6954,4385,5891,10190,15522,16833,23150,15738,27262,18525,19285)
bmi_sidorenko24_sd <- sqrt(
  sum((ns - 1) * sds^2) / sum(ns - 1)
  )

rm(sds,ns)

#If variable to normalise is the exposure, divide the beta by SD to convert the effect per-unit exposure to effect per-SD exposure.
#If variable to normalise is the outcome, multiple the beta by SD to convert the effect (units outcome) to effect (SD outcome).
bmi_dbp_sds <- c('DBP -> HCM' = dbp_keaton24_sd, 
                 'BMI -> HCM' = bmi_sidorenko24_sd,
                 'HCM -> DBP' = 1/dbp_keaton24_sd,
                 'HCM -> BMI' = 1/bmi_sidorenko24_sd)

if(isTRUE(bmi_dbp_normalisation)){
  mr_results <- perunit_to_perSD_normaliser(mr_results, bmi_dbp_sds)
  mr_results_or <- perunit_to_perSD_normaliser(mr_results_or, bmi_dbp_sds, type='mr_results_or')
}
```

This provides normalisation of the Thanaj et al, 2022 diastolic measures i.e longitudinal and radial diastolic strain rates into per-SD measures

```{r}
thanaj_dsr_normalisation <- T

longdsr_thanaj22_sd <- 0.6
radialdsr_thanaj22_sd <- 1.9

thanaj_dsr_sds <- c('longdsr -> HCM' = longdsr_thanaj22_sd,
                    'radialdsr -> HCM' = radialdsr_thanaj22_sd,
                    'HCM -> longdsr' = 1/longdsr_thanaj22_sd,
                    'HCM -> radialdsr' = 1/radialdsr_thanaj22_sd)

if(isTRUE(thanaj_dsr_normalisation)){
  mr_results <- perunit_to_perSD_normaliser(mr_results, thanaj_dsr_sds)
  mr_results_or <- perunit_to_perSD_normaliser(mr_results_or, thanaj_dsr_sds, type='mr_results_or')
}
```

## F-Statistic Summary

This imports in all the outputs from MendelianRandomization package which provides a F-statistic (first-stage) over all instruments for each MR analysis.
The threshold for sufficient instrument strength (to avoid weak instrument bias) should be > 10.

```{r}

MRpackage_importer <- function(input_folder){

  #Find the MRpackage_IVW_results.txt
  filename <- list.files(input_folder, pattern = 'MRpackage_IVW')
  path <- str_c(input_folder, filename, sep='/')
  con <- file(path,open="r")
  lines <- readLines(con)
  close(con)

  exposure_outcome <- str_match(path, '2_MR\\/([a-zA-Z_\\d]+)\\/')[,2]

  het_stats <- lines[which(str_detect(lines,'Heterogeneity'))]
  f_stat <- lines[which(str_detect(lines,'F statistic'))]

  isq <- as.numeric(str_match(het_stats, 'I\\^2 = ([\\d\\.]+)%')[,2])
  f <- as.numeric(str_match(f_stat, 'F statistic = ([\\d\\.]+)\\.')[,2])

  output_tb <- tribble(
    ~exposure_outcome, ~het_isq, ~fstat,
    exposure_outcome, isq, f
  )

  return(output_tb)
}

MRpackage_results <- map(str_c(results_folder, analyses), ~MRpackage_importer(.)) %>% bind_rows()
write_tsv(MRpackage_results , str_c(results_folder, 'summary_MRpackage_Isq_Fstat.tsv'))

#How many of the analyses have first-stage F statistic < 10
print(sum(MRpackage_results$fstat < 10))
```

## MR-PRESSO Summary

This imports in all the outputs from MRPRESSO package which provides 

- Global test for directional horizontal pleiotropy
- Outlier test for outlier removal to see if that corrects for directional horizontal pleiotropy
- Distortion test for whether the causal estimate overall is distorted before and after outlier removal

It also imports in the results from the Egger regression intercept != 0 test from the .md file.

```{r}
MRPRESSO_results_importer <- function(input_folder, return_outlier_tb = F){

  #Find the MRPRESSO results.txt
  filename <- list.files(input_folder, pattern = 'MRPRESSO_test.rds')
  path <- str_c(input_folder, filename, sep='/')
  exposure_outcome <- str_match(path, '2_MR\\/([a-zA-Z_\\d]+)\\/')[,2]

  if (length(filename) != 0){

    mrpresso_results <- readRDS(path)

    output_tb <- mrpresso_results$`Main MR results` %>% 
      select('analysis'='MR Analysis', 'estimate'='Causal Estimate', 'sd'='Sd', 'P-value') %>%
      pivot_wider(names_from ='analysis', values_from=c('estimate', 'sd','P-value')) %>%
      mutate(exposure_outcome = exposure_outcome) %>%
      select(exposure_outcome, everything())
    colnames(output_tb) <- c('exposure_outcome','Raw_estimate','Outlier_corrected_estimate','Raw_sd','Outlier_corrected_sd','Raw_pval','Outlier_corrected_pval')

    outlier_tb <- mrpresso_results$`MR-PRESSO results`$`Outlier Test` %>%
      mutate(exposure_outcome = exposure_outcome) %>%
      select(exposure_outcome, everything())

    distortion_pval <- mrpresso_results$`MR-PRESSO results`$`Distortion Test`$Pvalue

    output_tb <- output_tb %>%
      mutate(globaltest_pval = as.character(mrpresso_results$`MR-PRESSO results`$`Global Test`[[2]] )) %>%
      mutate(distortiontest_pval = ifelse(length(distortion_pval) == 0, '', as.character(distortion_pval)))

      if (!isFALSE(return_outlier_tb)){
        return(outlier_tb)
    } else {
      return(output_tb)
    }

  } else{
    return(NULL)
  }
}

MRPRESSO_results <- map(str_c(results_folder, analyses), ~MRPRESSO_results_importer (.)) %>% bind_rows()

```

This retrieves the Egger regression intercept != 0 test from each of the analyses.

```{r}
extract_egger_pval <- function(input_folder) {

  #Find the mr_report.md
  filename <- list.files(input_folder, pattern = 'mr_report')
  filepath <- str_c(input_folder, filename, sep='/')
  exposure_outcome <- str_match(filepath, '2_MR\\/([a-zA-Z_\\d]+)\\/')[,2]

  # Check if the file exists before proceeding
  if (length(filepath) == 0) {
    return(NULL)
    stop("Error: File not found at the specified path.")
  }

  # Read all lines from the file
  lines <- readLines(filepath, warn = FALSE)

  # Find the line index for the target section header
  # Using fixed = TRUE for performance and to avoid regex interpretation
  header_index <- grep("### Test for directional horizontal pleiotropy", lines, fixed = TRUE)

  # If the header isn't found, return NA
  if (length(header_index) == 0) {
    warning("Section 'Test for directional horizontal pleiotropy' not found.")
    return(NA)
  }

  # The p-value is expected to be in the data row, which is 4 lines below the header.
  # Structure: Header -> Blank Line -> Table Header -> Separator -> Data Row
  data_line_index <- header_index + 5

  # Check if the data line is within the bounds of the file content
  if (data_line_index > length(lines)) {
    warning("Could not find the data row for the Egger intercept test.")
    return(NA)
  }

  # Get the specific line containing the values
  data_line <- lines[data_line_index]

  # Split the line by the pipe "|" delimiter
  # The first element from strsplit is the one we want
  values <- strsplit(data_line, "\\|")[[1]]

  # Remove any empty strings that result from splitting
  non_empty_values <- values[values != ""]

  # Check if we have the expected number of columns (intercept, se, pval)
  if (length(non_empty_values) < 3) {
      warning("Egger intercept data row does not have the expected format.")
      return(NA)
  }
  
  # The p-value is the last element in the resulting vector
  pval_string <- trimws(non_empty_values[length(non_empty_values)])

  pval <- as.numeric(pval_string)
  output_tb <- tribble(
    ~exposure_outcome, ~egger_intercept_pval,
    exposure_outcome, pval
  )
  return(output_tb)
}

egger_intercept_pvals <- map(str_c(results_folder, analyses), ~extract_egger_pval(.)) %>% bind_rows()

#This also adds in sample sizes for each study
samplesizes <- readxl::read_excel('1_MR/1_data/gwas_summstats/hcm_related_traits_summary.xlsx', sheet=2) %>%
  select(PHENO, N) %>%
  filter(!is.na(PHENO), !is.na(N))

#This adds the Egger intercept pvalues to the actual MR-PRESSO ones
MRPRESSO_results <- left_join(MRPRESSO_results, egger_intercept_pvals, by='exposure_outcome')
write_tsv(MRPRESSO_results  , str_c(results_folder, 'summary_MRPRESSO.tsv'))
rm(egger_intercept_pvals)
```

## Analysis Filtering

This uses MRPRESSO to do some QC of the analyses.

```{r}
#Does the statistical significance of the IVW MR change after outlier correction using MR-PRESSO. This doesn't take into account multiple testing correction btw
MRPRESSO_results <- MRPRESSO_results %>%
  mutate(raw_sig = Raw_pval < 0.05,
          corrected_sig = Outlier_corrected_pval < 0.05) %>%
  mutate(sig_changes = raw_sig != corrected_sig) %>%
  arrange(globaltest_pval)
```

## Summary Plotting

This plots a volcano plot of all the MR analyses with BH's p-value correction for multiple testing correction (controls FWER but with greater power than Bonferroni and also does not assume independence between tests).

```{r}
#Apply multiple testing correction to the tests
mr_results <- mr_results %>%
  mutate(mtc_pval = p.adjust(pval, method='BH')) %>%
  mutate(group = ifelse(exposure=='HCM', 'HCM -> X', 'X -> HCM')) %>% #Separate a group variable based on whether HCM is the exposure or outcome
  mutate(label = ifelse(mtc_pval <= 0.05, exposure_outcome, '')) %>%
  mutate(exposure_phenogroup = case_when( exposure %in% crf_vars ~ 'CRF',
                                        # exposure %in% related_disease_vars ~'Related Diseases',
                                        exposure %in% pp_vars ~ 'PP',
                                        exposure %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        exposure %in% LV_diastolic_vars ~ 'LV Diastolic Function')) %>%
  mutate(outcome_phenogroup = case_when( outcome %in% crf_vars ~ 'CRF',
                                        # outcome %in% related_disease_vars ~'Related Diseases',
                                        outcome %in% pp_vars ~ 'PP',
                                        outcome %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        outcome %in% LV_diastolic_vars ~ 'LV Diastolic Function')) %>%
  mutate(nonHCM_phenogroup = case_when(is.na(exposure_phenogroup) ~ outcome_phenogroup, #This creates the phenogroup for the non-HCM variable in the analysis
                                       is.na(outcome_phenogroup) ~ exposure_phenogroup, 
                                       T~NA)) %>%
  mutate(nonHCM_phenogroup=factor(nonHCM_phenogroup, levels=unique(nonHCM_phenogroup)))
```


```{r}
#Output the summary scatter plot of pvalue with effect size
summary_scatter <- ggplot(mr_results,aes(x=b,y=-log10(mtc_pval)))+
  geom_point(aes(shape=group, col=nonHCM_phenogroup))+
  geom_vline(xintercept=0, linetype='dashed', col='black')+
  geom_hline(yintercept=-log10(0.05), linetype='dashed', col='black')+
  geom_text_repel(aes(label=label, col=nonHCM_phenogroup))+
  xlab('Beta (Change in Outcome per Change in Exposure)')+
  ylab('-log10 (Adjusted p-value)')+
  labs(shape='Direction', col='Non-HCM Phenotype Group')+
  labs(title=str_wrap(str_c('Summary plot of 2-sample Mendelian Randomisation for ', nrow(mr_results), ' analyses'))
       #,caption='Labelled if significant after MTC'
       )

print(summary_scatter)
ggsave('1_MR/3_output/3_summary_plots/MR_summary_plot.png',summary_scatter, dpi=600, width=9, height=6)

#Note that the RV traits all provide GWAS summary statistics/betas from the inverse-rank-normalised phenotypes. So their phenotype will be measured in SD.
#Likewise with DBP and BMI and Thanaj DSR which are normalised using the SD from the original publication.
```

Also include the plot with 95% confidence interval.
```{r}
#Output the summary scatter plot of pvalue with effect size
summary_scatter_confint <- ggplot(mr_results_or,aes(x=b,y=-log10(mtc_pval)))+
  geom_point(aes(shape=group, col=nonHCM_phenogroup))+
  geom_errorbar(aes(xmin=lo_ci, xmax=up_ci, col=nonHCM_phenogroup))+
  geom_vline(xintercept=0, linetype='dashed', col='black')+
  geom_hline(yintercept=-log10(0.05), linetype='dashed', col='black')+
  geom_text_repel(aes(label=label, col=nonHCM_phenogroup))+
  xlab('Beta (Change in Outcome per Change in Exposure)')+
  ylab('-log10 (Adjusted p-value)')+
  labs(shape='Direction', col='Non-HCM Phenotype Group')+
  labs(title=str_wrap(str_c('Summary plot of 2-sample Mendelian Randomisation for ', nrow(mr_results), ' analyses'))
       ,caption='Error bars = 95% confidence interval'
       )

print(summary_scatter_confint)
ggsave('1_MR/3_output/3_summary_plots/MR_summary_plot_confint.png',summary_scatter_confint, dpi=600, width=9, height=6)

#Note that the RV traits all provide GWAS summary statistics/betas from the inverse-rank-normalised phenotypes. So their phenotype will be measured in SD.
#Likewise with DBP and BMI and Thanaj DSR which are normalised using the SD from the original publication.
#The plasma proteins are all RINT in their GWAS so represent SD.
```

I also repeat the above summary plot but with the discrete variables transformed from Log(Odds) to Odds Ratio.

This is defunct because plotting odds-ratio is not good when you show both sides (i.e <0 and >0 are not equally well represented.)
```{r}
# #Convert all discrete variables to per-OR (instead of Log(Odds)) exposure and outcome
# discrete_vars <- c('SmokingInitiation','T2D', related_disease_vars, 'HCM', 'DCM')
# 
# #To convert outcome (per-log(OR) to OR), just exponentiate the beta (increase in log(OR) per unit exposure)
# #To convert exposure (per-log(OR) to OR), divide the 
# mr_results_or <- mr_results_or %>%
#   mutate(plot_y = case_when(outcome %in% discrete_vars ~ or,
#                             T~b),
#          plot_y_upci = case_when(outcome %in% discrete_vars~or_uci95,
#                                  T~up_ci),
#          plot_y_loci = case_when(outcome %in% discrete_vars~or_lci95,
#                                  T~lo_ci))
# 
# #Output the summary scatter plot of pvalue with effect size
# summary_scatter_confint_discreteoutcome_OR <- ggplot(mr_results_or,aes(x=plot_y,y=-log10(mtc_pval)))+
#   geom_point(aes(shape=group, col=nonHCM_phenogroup))+
#   geom_errorbar(aes(xmin=plot_y_loci, xmax=plot_y_upci, col=nonHCM_phenogroup))+
#   geom_vline(xintercept=0, linetype='dashed', col='black')+
#   geom_hline(yintercept=-log10(0.05), linetype='dashed', col='black')+
#   geom_text_repel(aes(label=label, col=nonHCM_phenogroup))+
#   xlab('Beta (Increase in Outcome per Increase in Exposure)')+
#   ylab('-log10 (Adjusted p-value)')+
#   labs(shape='Direction', col='Non-HCM Phenotype Group')+
#   labs(title=str_wrap(str_c('Summary plot of 2-sample Mendelian Randomisation for ', nrow(mr_results), ' analyses'))
#        ,caption='Error bars = 95% confidence interval'
#        )
# 
# print(summary_scatter_confint_discreteoutcome_OR)
# ggsave('1_MR/3_output/3_summary_plots/MR_summary_plot_confint_discreteoutcomeOR.png',summary_scatter_confint, dpi=600, width=9, height=6)
```


## Forest Plot for Significant Conclusions

```{r}
sig_mr_results_or <- mr_results_or %>%
  filter(exposure_outcome %in% filter(mr_results,mtc_pval <=0.05)$exposure_outcome)

#Create a faceted plot where I have the top plot = per-unit OR and the bottom plot = per-SD OR
if(isTRUE(bmi_dbp_normalisation) & isTRUE(thanaj_dsr_normalisation)){
  persd_exposure_vars <- c(pp_vars,'BMI','DBP','longdsr','radialdsr')
} else{
  persd_exposure_vars <- c(pp_vars)
}

sig_mr_results_or <- sig_mr_results_or %>%
  mutate(exposure_plot_group = case_when(exposure%in% persd_exposure_vars ~ 'Per-SD Exposure', 
                                       exposure %in% c('HF','HCM') ~ 'Per-Log(Odds) Exposure',
                                       T~'Per-Unit Exposure'))

sig_mr_results_or <- sig_mr_results_or %>%
  mutate(outcome_plot_group = ifelse(outcome %in% c('HCM','HF','CAD','stroke','T2D','SmokingInitiation'), 'OR', 'beta')) %>%
  mutate(exposure_outcome=factor(exposure_outcome))

forest_plot_overall <- ggplot(sig_mr_results_or)+
  geom_point(aes(x=b, y= exposure_outcome))+
  geom_errorbar(aes(xmin=lo_ci, xmax=up_ci, y=exposure_outcome))+
  geom_vline(xintercept=0, col='black', linetype='dashed')+
  xlab('Change in Outcome per Change in Exposure')+
  ylab('Exposure -> Outcome')+
  labs(col='Non-HCM Phenotype Group')+
  facet_wrap(vars(exposure_plot_group), nrow=3, drop=TRUE, scales='free')

print(forest_plot_overall)
ggsave('1_MR/3_output/3_summary_plots/sig_MR_forestplot.png',forest_plot_overall, dpi=600, width=9, height=6)
```

I also plot the forest plot broken down into 2 plots instead and where HCM or HF = exposure, do per doubling odds(HCM) and where it is outcome, do OR(HCM) or OR(HF).

```{r}

sig_mr_results_or_exposure_HCM <- filter(sig_mr_results_or, str_detect(exposure, 'HCM')) %>%
  mutate(scaled_b = ifelse(outcome == 'HF',exp(b*log(2)), b*log(2))) %>% #i.e if HCM -> HF, express as OR(HF) per doubling (Odds) of HCM
  mutate(scaled_lo_ci = ifelse(outcome == 'HF',exp(lo_ci*log(2)), lo_ci*log(2)),
        scaled_up_ci = ifelse(outcome == 'HF',exp(up_ci*log(2)), up_ci*log(2)))

#Plot this plot without HF signal
forest_plot_hcmexposure <- ggplot(filter(sig_mr_results_or_exposure_HCM, outcome != 'HF'))+
  geom_point(aes(x=scaled_b, y= exposure_outcome))+
  geom_errorbar(aes(xmin=scaled_lo_ci, xmax=scaled_up_ci, y=exposure_outcome))+
  geom_vline(xintercept=0, col='black', linetype='dashed')+
  xlab('Change in Outcome (SD) per Doubling of Odds(HCM)')+
  ylab('Exposure -> Outcome')+
  labs(col='Non-HCM Phenotype Group')

print(forest_plot_hcmexposure)
ggsave('1_MR/3_output/3_summary_plots/sig_MR_forestplot_hcmexposure.png',forest_plot_hcmexposure, dpi=600, width=6, height=3)

sig_mr_results_or_outcomeHCM <- filter(sig_mr_results_or, str_detect(outcome, 'HCM')) %>%
  mutate(scaled_b = ifelse(exposure == 'HF',exp(b*log(2)), b*log(2))) %>% #i.e if HF -> HCM , express as OR(HCM) per doubling (Odds) of HF
  mutate(scaled_lo_ci = ifelse(exposure == 'HF',exp(lo_ci*log(2)), lo_ci*log(2)),
        scaled_up_ci = ifelse(exposure == 'HF',exp(up_ci*log(2)), up_ci*log(2)))

forest_plot_hcmoutcome <- ggplot(filter(sig_mr_results_or_outcomeHCM, exposure != 'HF'))+
  geom_point(aes(x=or, y= exposure_outcome))+
  geom_errorbar(aes(xmin=or_lci95, xmax=or_uci95, y=exposure_outcome))+
  geom_vline(xintercept=1, col='black', linetype='dashed')+
  xlab('Per-SD Odds Ratio(HCM)')+
  ylab('Exposure -> Outcome')+
  labs(col='Non-HCM Phenotype Group')

print(forest_plot_hcmoutcome)
ggsave('1_MR/3_output/3_summary_plots/sig_MR_forestplot_hcmoutcome.png',forest_plot_hcmoutcome, dpi=600, width=6, height=3)


#Output combined plot
combined_forest_plot <- forest_plot_hcmexposure / forest_plot_hcmoutcome
print(combined_forest_plot)
ggsave('1_MR/3_output/3_summary_plots/sig_MR_forestplot_combined.png',combined_forest_plot, dpi=600, width=9, height=6)

```

```{r}
#Now plot the HF plots by themselves for both HCM -> HF and HF -> HCM
forest_plot_hcmexposure <- ggplot(filter(sig_mr_results_or_exposure_HCM, outcome == 'HF'))+
  geom_point(aes(x=scaled_b, y= exposure_outcome))+
  geom_errorbar(aes(xmin=scaled_lo_ci, xmax=scaled_up_ci, y=exposure_outcome))+
  geom_vline(xintercept=1, col='black', linetype='dashed')+
  xlab('Odds Ratio (HF) per Doubling of Odds(HCM)')+
  ylab('Exposure -> Outcome')

forest_plot_hcmoutcome <- ggplot(filter(sig_mr_results_or_outcomeHCM, exposure == 'HF'))+
  geom_point(aes(x=or, y= exposure_outcome))+
  geom_errorbar(aes(xmin=or_lci95, xmax=or_uci95, y=exposure_outcome))+
  geom_vline(xintercept=1, col='black', linetype='dashed')+
  xlab('Odds Ratio(HCM) per Doubling of Odds(HF)')+
  ylab('Exposure -> Outcome')

combined_forest_plot <- forest_plot_hcmexposure / forest_plot_hcmoutcome
print(combined_forest_plot)
ggsave('1_MR/3_output/3_summary_plots/sig_MR_forestplot_combined_HFonly.png',combined_forest_plot, dpi=600, width=6, height=3)

#N.B To get the numerical values
num_values <- mr_results_or %>%
  filter(exposure_outcome %in% c('HCM -> hcmr_NTproBNP',
                                    'HCM -> hcmr_TnT',
                                    'HCM -> radialdsr',
                                    'HCM -> longdsr')) %>%
  mutate(b = b*log(2), lo_ci = lo_ci*log(2), up_ci = up_ci * log(2)) %>%
  select(-contains('or'))

```

## Subgroup Analyses

I perform subgroup analyses for the significant conclusions seen from the initial MR analysis i.e. for sarcomere-positive and sarcomere-negative.

```{r}
results_folder <- '1_MR/3_output/2_MR/subgroup_analyses/'
analyses <- list.dirs(results_folder, recursive=F, full.names=F)
analyses <- analyses[!analyses %in% c('main_analysis_notsig')]

subgroup_mr_results_or <- map(str_c(results_folder, analyses), ~sensitivity_or_results_importer(.)) %>% bind_rows() %>%
  filter(method %in% c('Wald ratio','Inverse variance weighted')) %>%
  mutate(label = ifelse(pval <= 0.05, exposure_outcome, '')) %>%
  mutate(group = ifelse(str_detect(exposure, 'HCM'), 'HCM -> X', 'X -> HCM')) %>% #Separate a group variable based on whether HCM is the exposure or outcome
    mutate(exposure_phenogroup = case_when( exposure %in% crf_vars ~ 'CRF',
                                        # exposure %in% related_disease_vars ~'Related Diseases',
                                        exposure %in% pp_vars ~ 'PP',
                                        exposure %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        exposure %in% LV_diastolic_vars ~ 'LV Diastolic Function')) %>%
  mutate(outcome_phenogroup = case_when( outcome %in% crf_vars ~ 'CRF',
                                        # outcome %in% related_disease_vars ~'Related Diseases',
                                        outcome %in% pp_vars ~ 'PP',
                                        outcome %in% fibrosis_vars ~ 'Myocardial Fibrosis',
                                        outcome %in% LV_diastolic_vars ~ 'LV Diastolic Function')) %>%
  mutate(nonHCM_phenogroup = case_when(is.na(exposure_phenogroup) ~ outcome_phenogroup, #This creates the phenogroup for the non-HCM variable in the analysis
                                       is.na(outcome_phenogroup) ~ exposure_phenogroup, 
                                       T~NA)) %>%
  mutate(nonHCM_phenogroup=factor(nonHCM_phenogroup, levels=unique(nonHCM_phenogroup)))
```

Applying normalisation to some of the continuous values to per-SD.

```{r}
bmi_dbp_subgroup_sds <- c(
  'DBP -> HCMsarcneg' = dbp_keaton24_sd, 
  'DBP -> HCMsarcpos' = dbp_keaton24_sd, 
  'BMI -> HCMsarcneg' = bmi_sidorenko24_sd,
  'BMI -> HCMsarcpos' = bmi_sidorenko24_sd)

thanaj_dsr_subgroup_sds <- c(
                    'HCMsarcneg -> longdsr' = 1/longdsr_thanaj22_sd,
                    'HCMsarcpos -> longdsr' = 1/longdsr_thanaj22_sd,
                    'HCMsarcneg -> radialdsr' = 1/radialdsr_thanaj22_sd,
                    'HCMsarcpos -> radialdsr' = 1/radialdsr_thanaj22_sd)

subgroup_mr_results_or <- perunit_to_perSD_normaliser(subgroup_mr_results_or, bmi_dbp_subgroup_sds, type='mr_results_or')
subgroup_mr_results_or <- perunit_to_perSD_normaliser(subgroup_mr_results_or, thanaj_dsr_subgroup_sds, type='mr_results_or')

if(isTRUE(bmi_dbp_normalisation) & isTRUE(thanaj_dsr_normalisation)){
  persd_vars <- c(pp_vars, 'BMI','DBP','longdsr','radialdsr')
} else{
  persd_vars <- c(pp_vars)
}

```



```{r}
subgroup_mr_results_or <- subgroup_mr_results_or %>%
  mutate(outcome_plot_group = case_when(outcome %in% c('HCM','HCMsarcneg','HCMsarcpos',related_disease_vars,'T2D','SmokingInitiation') ~ 'Discrete Outcome',
                                        outcome %in% persd_vars ~ 'Continuous Outcome')) %>%
  mutate(exposure_plot_group = case_when(exposure %in% persd_vars~ 'Per-SD Exposure',
                                         exposure %in% c('HCM','HCMsarcneg','HCMsarcpos',related_disease_vars,'T2D','SmokingInitiation') ~ 'Per-Log(Odds) Exposure')) %>%
  mutate(sarcgroup = ifelse(str_detect(exposure_outcome,'sarcneg'), 'Sarcomere-Negative', 'Sarcomere-Positive')) %>%
  mutate(exposure = ifelse(str_detect(exposure, 'HCM'),'HCM',exposure)) %>% #This simplifies the label to HCM
  mutate(outcome = ifelse(str_detect(outcome, 'HCM'),'HCM',outcome)) %>%  #So that you have 2 points per y-label
  mutate(exposure_outcome = str_c(exposure, ' -> ', outcome)) %>%
  mutate(exposure_outcome=factor(exposure_outcome))

forest_plot_subgroup_hcm_exposure<- ggplot(filter(subgroup_mr_results_or, str_detect(exposure, 'HCM')))+
  geom_point(aes(x=b, y= forcats::fct_reorder(exposure_outcome, outcome), col=sarcgroup),
             position = position_dodge(width = 0.35))+
  geom_errorbar(aes(xmin=lo_ci, xmax=up_ci, y=exposure_outcome,col=sarcgroup),
                position = position_dodge(width = 0.35),
                width = 0.25)+
  geom_vline(xintercept=0, col='black', linetype='dashed')+
  xlab('Change in Outcome (SD) per Change in Exposure')+ #Because currently only continuous outcomes
  ylab('Exposure -> Outcome')+
  labs(col='Sarcomere Subroup',  caption='95% confidence intervals shown')+
  facet_wrap(vars(outcome_plot_group), nrow=3, drop=TRUE, scales='free')

print(forest_plot_subgroup_hcm_exposure)
ggsave('1_MR/3_output/3_summary_plots/sig_MR_forestplot_subgroup_hcmexposure.png',forest_plot_subgroup_hcm_exposure, dpi=600, width=6, height=3)

forest_plot_subgroup_hcm_outcome<- ggplot(filter(subgroup_mr_results_or, str_detect(outcome, 'HCM')))+
  geom_point(aes(x=b, y= forcats::fct_reorder(exposure_outcome, exposure), col=sarcgroup),
             position = position_dodge(width = 0.35))+
  geom_errorbar(aes(xmin=lo_ci, xmax=up_ci, y=exposure_outcome,col=sarcgroup),
                position = position_dodge(width = 0.35),
                width=0.25)+
  geom_vline(xintercept=0, col='black', linetype='dashed')+
  xlab('Change in Outcome (Log(Odds)) per Change in Exposure')+
  ylab('Exposure -> Outcome')+
  labs(col='Sarcomere Subgroup',  caption='95% confidence intervals shown')+
  facet_wrap(vars(exposure_plot_group), nrow=3, drop=TRUE, scales='free')

print(forest_plot_subgroup_hcm_outcome)
ggsave('1_MR/3_output/3_summary_plots/sig_MR_forestplot_subgroup_hcmoutcome.png',forest_plot_subgroup_hcm_outcome, dpi=600, width=6, height=3)
```

```{r}
#Plot the increase in phenotpye per doubling of odds of HCM for HCM = Exposure as per Burgess et al, 2019
forest_plot_subgroup_hcm_exposure_doubleOdds<- ggplot(filter(subgroup_mr_results_or, str_detect(exposure, 'HCM')))+
  geom_point(aes(x=b * log(2), y= forcats::fct_reorder(exposure_outcome, outcome), col=sarcgroup),
             position = position_dodge(width = 0.35))+
  geom_errorbar(aes(xmin=lo_ci* log(2), xmax=up_ci* log(2), y=exposure_outcome,col=sarcgroup),
                position = position_dodge(width = 0.35),
                width = 0.25)+
  geom_vline(xintercept=0, col='black', linetype='dashed')+
  xlab('Change in Outcome (SD) per Doubling of Odds of HCM')+ #Because currently only continuous outcomes
  ylab('Exposure -> Outcome')+
  labs(col='Sarcomere Subroup',  caption='95% confidence intervals shown')

print(forest_plot_subgroup_hcm_exposure_doubleOdds)
ggsave('1_MR/3_output/3_summary_plots/sig_MR_forestplot_subgroup_hcmexposure_doubleOdds.png',forest_plot_subgroup_hcm_exposure_doubleOdds, dpi=600, width=6, height=3)

#Plot the Odds Ratio of HCM Outcome instead of the Log(Odds Ratio)
forest_plot_subgroup_hcm_outcome_OR<- ggplot(filter(subgroup_mr_results_or, str_detect(outcome, 'HCM')))+
  geom_point(aes(x=or, y= forcats::fct_reorder(exposure_outcome, exposure), col=sarcgroup),
             position = position_dodge(width = 0.35))+
  geom_errorbar(aes(xmin=or_lci95, xmax=or_uci95, y=exposure_outcome,col=sarcgroup),
                position = position_dodge(width = 0.35),
                width=0.25)+
  geom_vline(xintercept=1, col='black', linetype='dashed')+
  xlab('Odds Ratio(HCM) per Increase in Exposure (SD)')+
  ylab('Exposure -> Outcome')+
  labs(col='Sarcomere Subgroup',  caption='95% confidence intervals shown')

print(forest_plot_subgroup_hcm_outcome_OR)
ggsave('1_MR/3_output/3_summary_plots/sig_MR_forestplot_subgroup_hcmoutcome_OR.png',forest_plot_subgroup_hcm_outcome_OR, dpi=600, width=6, height=3)
```



## Misc.

### Double-Check Separate Instruments

```{r}
library(readxl)

double_check_separate_instruments <- function(associations_filepath, reference_IVlist){
  
  phenotype_name <- str_match(associations_filepath, '\\/([A-Za-z_0-9]+)_associations\\.')[,2]
  
  if(any(str_detect(associations_filepath, 'tsv'))){ #i.e if a file path is passed instead of a list of SNPs
  associations_filepath <- read_tsv(associations_filepath, show_col_types=F) %>%
    filter(`P-VALUE` <= 5 * 10^-8) #Filter for only GWS SNPs in the passed in file
  associations_filepath <- associations_filepath$SNPS
} else if (any(str_detect(associations_filepath, 'csv'))){
  associations_filepath <- read_csv(associations_filepath, show_col_types=F) %>% 
    filter(pValue <= 5 * 10^-8) #Filter for only GWS SNPs in the passed in file
  associations_filepath <- associations_filepath$dbSNP
} else if (any(str_detect(associations_filepath, '.xlsx'))){
  associations_filepath <- read_excel(associations_filepath, sheet='Sheet1')
  associations_filepath <- associations_filepath$rsid
}
  
  overlap <- sum(associations_filepath %in% reference_IVlist)
  if(overlap == 0){
    print(str_c(phenotype_name, ' has no overlap with IV list'))
  } else {
    print(str_c(phenotype_name, ' HAS overlap with IV list'))
    overlapping_snps <- associations_filepath[which(associations_filepath %in% reference_IVlist)]
    print(str_c('Overlapping SNPs = ', str_c(overlapping_snps, collapse = ', ')))
  }
  
}

hcm_gws_snps = str_split_1("rs1048302,rs11687178,rs3845778,rs2540277,rs6747402,rs7612736,rs4894803,rs2191446,rs11748963,rs3176326,rs12210733,rs66520020,rs7824244,rs35006907,rs2645210,rs2177843,rs11196085,rs17617337,rs12270374,rs182427065,rs7487962,rs41306688,rs113907726,rs8006225,rs8033459,rs28768976,rs7210446,rs2644262,rs6566955,rs12460541,rs62222424,rs5760054",',')

association_files <- list.files('../1_data/gwas_associations/', pattern='associations', full.names=T)
walk(association_files, ~double_check_separate_instruments(.,hcm_gws_snps))

```


